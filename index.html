<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Friend Chat</title>
<style>
:root{ --vh:1vh; }
*{ box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont; }
body{ background:#0d0d0d; color:#fff; height:calc(var(--vh)*100); display:flex; flex-direction:column; }

#loginBox{
  flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px;
  background: linear-gradient(135deg,#1d1d1d,#111); border-radius:12px; margin:40px;
}
#loginBox h2{margin-bottom:10px; font-size:28px; color:#1d9bf0;}
#credit{font-size:12px;color:#777;margin-bottom:20px;}
#loginBox input,#loginBox button{
  width:100%; max-width:300px; padding:14px; margin:10px 0; border-radius:12px; border:none; font-size:16px;
}
#loginBox input{background:#222;color:#fff;}
#loginBox button{
  background:#1d9bf0;color:#fff;font-weight:bold;cursor:pointer;
  transition:0.3s; 
}
#loginBox button:hover{ background:#0c7cd5; }

/* CHAT SCREEN */
#chatScreen{ display:none; flex:1; flex-direction:column; min-height:0; }

/* HEADER */
header{
  flex-shrink:0; padding:12px; border-bottom:1px solid #222; background:#111; display:flex; justify-content:space-between; align-items:center;
}
#roomName{font-weight:600; font-size:18px;}
#onlineUsers{font-size:12px; color:#aaa;}

/* CHAT AREA */
#chat{ flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
.msg{ max-width:70%; padding:10px 14px; margin:6px 0; border-radius:18px; word-wrap:break-word; font-size:15px; opacity:0; transition:0.5s; }
.left{ align-self:flex-start; background:#1e1e1e; border-bottom-left-radius:4px; }
.right{ align-self:flex-end; background:#1d9bf0; color:#fff; border-bottom-right-radius:4px; }
.seen{ font-size:11px; color:#aaa; text-align:right; margin-right:8px; }

/* TYPING */
#typing{ font-size:12px; color:#aaa; padding-left:10px; height:16px; font-style:italic; }

/* FOOTER */
footer{ flex-shrink:0; display:flex; gap:8px; padding:8px; border-top:1px solid #222; background:#111; }
footer input{ flex:1; padding:12px; border-radius:20px; border:none; background:#1e1e1e; color:#fff; font-size:14px; }
footer button{ padding:0 16px; border-radius:50%; border:none; background:#1d9bf0; color:#fff; font-size:18px; cursor:pointer; }

/* LEAVE */
#leaveBtn{ background:#e53935; border:none; color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; cursor:pointer; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>üîê Private Chat</h2>
  <div id="credit">Website by @rp_gupta_07</div>
  <input id="username" placeholder="Enter your name">
  <input id="roomcode" placeholder="Enter room code">
  <button id="enterBtn">Enter Chat</button>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <header>
    <div id="roomName"></div>
    <div id="onlineUsers"></div>
    <button id="leaveBtn">Leave</button>
  </header>

  <div id="chat"></div>
  <div id="typing"></div>

  <footer>
    <input id="msg" placeholder="Type a message...">
    <button id="sendBtn">‚û§</button>
  </footer>
</div>

<script type="module">
function setVH(){ document.documentElement.style.setProperty('--vh', window.innerHeight*0.01+'px'); }
setVH();
window.addEventListener('resize', setVH);

/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, remove, update } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  authDomain: "friendchat-43941.firebaseapp.com",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941",
  storageBucket: "friendchat-43941.firebasestorage.app",
  messagingSenderId: "1026542245723",
  appId: "1:1026542245723:web:b892bfcc1d2358a018ac7e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM ELEMENTS */
const loginBox = document.getElementById("loginBox");
const chatScreen = document.getElementById("chatScreen");
const chatDiv = document.getElementById("chat");
const typingDiv = document.getElementById("typing");
const roomName = document.getElementById("roomName");
const onlineUsers = document.getElementById("onlineUsers");
const enterBtn = document.getElementById("enterBtn");
const sendBtn = document.getElementById("sendBtn");
const leaveBtn = document.getElementById("leaveBtn");
const usernameInput = document.getElementById("username");
const roomInput = document.getElementById("roomcode");
const msgInput = document.getElementById("msg");

/* STATE */
let user="", room="", chatRef, typingRef, userRef;

/* ENTER CHAT */
enterBtn.addEventListener("click", async ()=>{
  user = usernameInput.value.trim();
  room = roomInput.value.trim();
  if(!user||!room){ alert("Name aur Room code likho"); return; }

  chatDiv.innerHTML = "";
  typingDiv.textContent = "";

  const userRefCheck = ref(db,`rooms/${room}/users/${user}`);
  let exists = false;
  await onValue(userRefCheck, snap=>{ if(snap.exists()) exists = true; }, { onlyOnce:true });
  if(exists){ alert("Ye username room me already exist karta hai! Alag name try karo."); return; }

  loginBox.style.display="none";
  chatScreen.style.display="flex";
  roomName.textContent = "Room: "+room;

  chatRef = ref(db,`rooms/${room}/messages`);
  typingRef = ref(db,`rooms/${room}/typing/${user}`);
  userRef = ref(db,`rooms/${room}/users/${user}`);

  set(userRef,true);
  set(typingRef,false);

  /* ONLINE USERS */
  onValue(ref(db,`rooms/${room}/users`), snap=>{
    const names = snap.exists()?Object.keys(snap.val()):[];
    onlineUsers.textContent = names.length+" online: "+names.join(", ");
  });

  /* TYPING STATUS */
  onValue(ref(db,`rooms/${room}/typing`), snap=>{
    let text="";
    snap.forEach(c=>{ if(c.key!==user && c.val()===true) text+=c.key+" typing... "; });
    typingDiv.textContent = text;
  });

  /* MESSAGES DISPLAY */
  onChildAdded(chatRef, snap=>{
    const m = snap.val();
    const div = document.createElement("div");
    div.className = "msg "+(m.user===user?"right":"left");
    div.innerHTML = (m.user===user ? m.text : "<b>"+m.user+"</b><br>"+m.text);
    chatDiv.appendChild(div);
    setTimeout(()=>{ div.style.opacity=1; },100); // slow fade-in

    if(m.user!==user){ update(ref(db,`rooms/${room}/messages/${snap.key}`),{seen:true}); }
    if(m.user===user){
      const seenDiv = document.createElement("div");
      seenDiv.className="seen";
      seenDiv.textContent = m.seen?"Seen ‚úî‚úî":"Sent ‚úî";
      chatDiv.appendChild(seenDiv);
    }
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
});

/* SEND MESSAGE */
sendBtn.addEventListener("click", ()=>{
  const text = msgInput.value.trim();
  if(!text) return;
  push(chatRef,{user,text,time:Date.now(),seen:false});
  msgInput.value="";
  set(typingRef,false);
});

/* TYPING STATUS */
msgInput.addEventListener("input",()=>{ set(typingRef,msgInput.value.trim()!==""); });

/* LEAVE ROOM */
leaveBtn.addEventListener("click", ()=>{
  remove(userRef);
  remove(typingRef);
  location.reload();
});

/* SCROLL FIX */
msgInput.addEventListener("focus",()=>{ setTimeout(()=>chatDiv.scrollTop=chatDiv.scrollHeight,300); });
</script>
</body>
</html>
