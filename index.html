<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Arena Pro | Community</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
:root { --primary: #00f2ff; --secondary: #7000ff; --bg: #050505; --card: rgba(255, 255, 255, 0.05); --win: #00ff88; }
* { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
body { margin: 0; background: var(--bg); color: #fff; overflow-x: hidden; }

.container { max-width: 450px; margin: auto; min-height: 100vh; display: flex; flex-direction: column; }
.screen { padding: 20px; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Profile Section */
.profile-setup { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #222; margin-bottom: 20px; }
.avatar { width: 60px; height: 60px; background: var(--secondary); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 2px solid var(--primary); }

input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #111; color: #fff; margin-bottom: 10px; outline: none; }
input:focus { border-color: var(--primary); }

.btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
.btn-primary { background: var(--primary); color: #000; }
.btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

/* Online Players List */
.player-list { background: var(--card); border-radius: 15px; padding: 15px; flex: 1; }
.player-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 8px; border: 1px solid transparent; }
.player-item:hover { border-color: var(--primary); background: rgba(0, 242, 255, 0.05); }
.status-dot { width: 8px; height: 8px; background: var(--win); border-radius: 50%; margin-right: 10px; box-shadow: 0 0 5px var(--win); }

/* Game Board */
#board { display: grid; gap: 8px; margin: 20px auto; }
.cell { background: var(--card); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; cursor: pointer; border: 1px solid #333; height: 80px; width: 80px; }
.winner-cell { background: var(--win) !important; color: #000 !important; }

.hidden { display: none !important; }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; text-align: center; }
</style>
</head>
<body>

<div class="container">
    <div id="setupScreen" class="screen">
        <h2 style="text-align: center; color: var(--primary);">ARENA PRO</h2>
        <div class="profile-setup">
            <div class="avatar" id="pfp">?</div>
            <input id="uName" placeholder="Enter Name">
            <input id="uTag" placeholder="Enter Username (e.g. rp_07)">
            <button class="btn btn-primary" onclick="registerUser()">START EXPLORING</button>
        </div>
    </div>

    <div id="lobbyScreen" class="screen hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <span style="font-size: 12px; color: #888;">Welcome,</span>
                <div id="myDisplayName" style="font-weight: bold; color: var(--primary);">User</div>
            </div>
            <button onclick="logout()" style="background:none; border:none; color: #ff4444; font-size: 12px;">Logout</button>
        </div>

        <h3 style="font-size: 14px; letter-spacing: 1px; color: #555;">ONLINE PLAYERS (Tap to Challenge)</h3>
        <div id="playerList" class="player-list">
            </div>
    </div>

    <div id="gameScreen" class="screen hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button class="btn-outline" style="width: auto; padding: 5px 15px;" onclick="exitGame()">EXIT</button>
            <div id="turnStatus" style="color: var(--win); font-weight: bold;">Game Starting...</div>
        </div>
        <div id="board" style="grid-template-columns: repeat(3, 80px); justify-content: center;"></div>
    </div>
</div>

<div id="challengeOverlay" class="overlay hidden">
    <div style="background: #111; padding: 30px; border-radius: 20px; border: 1px solid var(--primary);">
        <h3 id="challengerText">Someone challenged you!</h3>
        <button class="btn btn-primary" onclick="acceptChallenge()">ACCEPT</button>
        <button class="btn btn-outline" onclick="declineChallenge()">DECLINE</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941",
  appId: "1:1026542245723:web:b892bfcc1d2358a018ac7e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let currentRoom = null;
let mySym = "X";

// 1. Profile Logic
function registerUser() {
    const name = document.getElementById("uName").value.trim();
    const tag = document.getElementById("uTag").value.trim();
    if(!name || !tag) return alert("Fill all details!");

    currentUser = { name, tag, id: tag.replace(/\W/g, '') };
    localStorage.setItem("arena_user", JSON.stringify(currentUser));
    
    // Set Online Status
    db.ref("online_users/" + currentUser.id).set({ ...currentUser, status: "online" });
    db.ref("online_users/" + currentUser.id).onDisconnect().remove();

    showLobby();
}

function showLobby() {
    document.getElementById("setupScreen").classList.add("hidden");
    document.getElementById("lobbyScreen").classList.remove("hidden");
    document.getElementById("myDisplayName").innerText = currentUser.name + " (@" + currentUser.tag + ")";
    listenPlayers();
    listenChallenges();
}

// 2. Real-time Player List
function listenPlayers() {
    db.ref("online_users").on("value", snap => {
        const players = snap.val();
        const listDiv = document.getElementById("playerList");
        listDiv.innerHTML = "";
        
        for(let id in players) {
            if(id === currentUser.id) continue;
            const p = players[id];
            const div = document.createElement("div");
            div.className = "player-item";
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="status-dot"></div>
                    <div>
                        <div style="font-size:14px; font-weight:bold;">${p.name}</div>
                        <div style="font-size:10px; color:#666;">@${p.tag}</div>
                    </div>
                </div>
                <button class="btn-outline" style="width:auto; margin:0; padding:5px 10px; font-size:10px;" onclick="sendChallenge('${p.id}')">PLAY</button>
            `;
            listDiv.appendChild(div);
        }
    });
}

// 3. Challenge System
function sendChallenge(targetId) {
    const roomId = "ROOM_" + [currentUser.id, targetId].sort().join("_");
    db.ref("challenges/" + targetId).set({ from: currentUser, roomId: roomId });
    alert("Challenge sent! Waiting for player...");
}

function listenChallenges() {
    db.ref("challenges/" + currentUser.id).on("value", snap => {
        const chal = snap.val();
        if(chal) {
            currentRoom = chal.roomId;
            document.getElementById("challengerText").innerText = chal.from.name + " challenged you!";
            document.getElementById("challengeOverlay").classList.remove("hidden");
        }
    });
}

function acceptChallenge() {
    db.ref("rooms/" + currentRoom).set({
        board: Array(9).fill(""),
        turn: "X",
        players: { X: "Waiting...", O: currentUser.id } // Challenger is X, Accepter is O
    });
    db.ref("challenges/" + currentUser.id).remove();
    document.getElementById("challengeOverlay").classList.add("hidden");
    startGame(currentRoom, "O");
}

// Automate game entry for Challenger
db.ref("rooms").on("child_added", snap => {
    if(currentRoom && snap.key === currentRoom && !currentUser.inGame) {
        startGame(currentRoom, "X");
    }
});

// 4. Game Logic
function startGame(roomId, sym) {
    currentRoom = roomId;
    mySym = sym;
    currentUser.inGame = true;
    document.getElementById("lobbyScreen").classList.add("hidden");
    document.getElementById("gameScreen").classList.remove("hidden");
    
    const boardDiv = document.getElementById("board");
    boardDiv.innerHTML = "";
    for(let i=0; i<9; i++) {
        const c = document.createElement("div");
        c.className = "cell";
        c.onclick = () => makeMove(i);
        boardDiv.appendChild(c);
    }
    
    db.ref("rooms/" + currentRoom).on("value", syncGame);
}

function syncGame(snap) {
    const g = snap.val();
    if(!g) return;
    
    g.board.forEach((v, i) => {
        const cell = document.getElementById("board").children[i];
        cell.innerText = v;
        cell.style.color = v === "X" ? "var(--primary)" : "var(--secondary)";
    });

    if(checkWin(g.board)) {
        document.getElementById("turnStatus").innerText = "GAME OVER!";
        if(checkWin(g.board) === mySym) {
            confetti({ particleCount: 150 });
            alert("YOU WON!");
        }
    } else {
        document.getElementById("turnStatus").innerText = g.turn === mySym ? "YOUR TURN" : "WAITING...";
    }
}

function makeMove(i) {
    db.ref("rooms/" + currentRoom).once("value", snap => {
        const g = snap.val();
        if(g.turn === mySym && g.board[i] === "") {
            g.board[i] = mySym;
            g.turn = mySym === "X" ? "O" : "X";
            db.ref("rooms/" + currentRoom).update(g);
        }
    });
}

function checkWin(b) {
    const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for(let w of wins) {
        if(b[w[0]] && b[w[0]]===b[w[1]] && b[w[1]]===b[w[2]]) return b[w[0]];
    }
    return null;
}

function exitGame() { location.reload(); }
function logout() { localStorage.clear(); location.reload(); }

// Auto-Login
const saved = localStorage.getItem("arena_user");
if(saved) {
    currentUser = JSON.parse(saved);
    db.ref("online_users/" + currentUser.id).set({ ...currentUser, status: "online" });
    showLobby();
}
</script>
</body>
</html>

