<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Arena Pro | Community Chat & Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
:root { --primary: #00f2ff; --secondary: #7000ff; --bg: #050505; --card: rgba(255, 255, 255, 0.05); --win: #00ff88; --me: #0084ff; }
* { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
body { margin: 0; background: var(--bg); color: #fff; overflow: hidden; height: 100vh; }

.container { max-width: 450px; margin: auto; height: 100vh; display: flex; flex-direction: column; position: relative; }
.screen { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }

/* Profile Section */
.profile-setup { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #222; }
.avatar { width: 60px; height: 60px; background: var(--secondary); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 2px solid var(--primary); }

input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #111; color: #fff; margin-bottom: 10px; outline: none; }
.btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
.btn-primary { background: var(--primary); color: #000; }

/* Lobby UI */
.online-header { font-size: 12px; color: var(--primary); margin-bottom: 10px; letter-spacing: 1px; display: block; }
.player-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.player-chip { flex: 0 0 auto; background: var(--card); padding: 8px 15px; border-radius: 20px; border: 1px solid #333; font-size: 12px; cursor: pointer; text-align: center; }

/* Global Chat */
.chat-container { flex: 1; display: flex; flex-direction: column; background: rgba(255,255,255,0.02); border-radius: 15px; padding: 10px; overflow: hidden; }
#messages { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 5px; }
.msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; position: relative; }
.msg.me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 2px; }
.msg.other { align-self: flex-start; background: #2a2a2a; border-bottom-left-radius: 2px; }
.msg-info { font-size: 8px; opacity: 0.6; display: block; margin-bottom: 2px; text-transform: uppercase; }

/* Game Overlay */
.game-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; padding: 20px; }
#board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: 40px auto; }
.cell { background: var(--card); border-radius: 15px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; border: 1px solid #333; }

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="container">
    <div id="setupScreen" class="screen">
        <h2 style="text-align: center; color: var(--primary); margin-top: 40px;">ARENA PRO</h2>
        <div class="profile-setup">
            <div class="avatar" id="pfp">?</div>
            <input id="uName" placeholder="Apna Name Likho">
            <input id="uTag" placeholder="Username (e.g. ram_01)">
            <button class="btn btn-primary" onclick="registerUser()">JOIN COMMUNITY</button>
        </div>
    </div>

    <div id="lobbyScreen" class="screen hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-weight: bold; color: var(--primary);" id="welcomeName">User</div>
            <button onclick="logout()" style="color: red; background: none; border: none; font-size: 12px;">LOGOUT</button>
        </div>

        <span class="online-header">ONLINE PLAYERS (Tap to Challenge)</span>
        <div id="playerList" class="player-list">
            <div style="font-size: 10px; color: #555;">No one online...</div>
        </div>

        <div class="chat-container">
            <span style="font-size: 10px; color: #555; margin-bottom: 5px; text-align: center;">GLOBAL ARENA CHAT</span>
            <div id="messages"></div>
            <div style="display: flex; gap: 5px; margin-top: 10px;">
                <input id="msgInput" placeholder="Message..." style="margin:0; flex:1;">
                <button onclick="sendGlobalMsg()" style="background:var(--primary); border:none; border-radius:10px; width:45px;">➤</button>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="game-screen hidden">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <button onclick="exitGame()" style="background:none; border: 1px solid #444; color:#fff; padding:5px 15px; border-radius:10px;">QUIT</button>
            <div id="turnStatus" style="color: var(--win); font-weight: bold;">YOUR TURN</div>
        </div>
        <div id="board"></div>
    </div>
</div>

<div id="challengeOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; display:flex; align-items:center; justify-content:center;" class="hidden">
    <div style="background:#111; padding:25px; border-radius:20px; border:1px solid var(--primary); text-align:center;">
        <h3 id="challengerText">Challenge!</h3>
        <button class="btn btn-primary" onclick="acceptChallenge()">ACCEPT</button>
        <button class="btn" style="background:#333; color:#fff;" onclick="declineChallenge()">DECLINE</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941",
  appId: "1:1026542245723:web:b892bfcc1d2358a018ac7e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let currentRoom = null;
let mySym = "X";

// 1. Profile & Setup
function registerUser() {
    const name = document.getElementById("uName").value.trim();
    const tag = document.getElementById("uTag").value.trim();
    if(!name || !tag) return alert("Pehle details bharo!");

    currentUser = { name, tag, id: tag.replace(/\W/g, '') };
    localStorage.setItem("arena_user", JSON.stringify(currentUser));
    
    db.ref("online_users/" + currentUser.id).set({ ...currentUser, status: "online" });
    db.ref("online_users/" + currentUser.id).onDisconnect().remove();

    showLobby();
}

function showLobby() {
    document.getElementById("setupScreen").classList.add("hidden");
    document.getElementById("lobbyScreen").classList.remove("hidden");
    document.getElementById("welcomeName").innerText = currentUser.name;
    listenPlayers();
    listenChallenges();
    listenGlobalChat();
}

// 2. Online Players & Challenge
function listenPlayers() {
    db.ref("online_users").on("value", snap => {
        const listDiv = document.getElementById("playerList");
        listDiv.innerHTML = "";
        const players = snap.val();
        let count = 0;
        for(let id in players) {
            if(id === currentUser.id) continue;
            count++;
            const p = players[id];
            const chip = document.createElement("div");
            chip.className = "player-chip";
            chip.innerHTML = `<div style="color:var(--win); font-size:8px;">●</div>${p.name}`;
            chip.onclick = () => sendChallenge(p.id);
            listDiv.appendChild(chip);
        }
        if(count === 0) listDiv.innerHTML = "<div style='font-size:10px; color:#555;'>No one online...</div>";
    });
}

function sendChallenge(targetId) {
    const roomId = "ROOM_" + [currentUser.id, targetId].sort().join("_");
    db.ref("challenges/" + targetId).set({ from: currentUser, roomId: roomId });
    alert("Challenge sent to " + targetId + "!");
}

function listenChallenges() {
    db.ref("challenges/" + currentUser.id).on("value", snap => {
        const chal = snap.val();
        if(chal) {
            currentRoom = chal.roomId;
            document.getElementById("challengerText").innerText = chal.from.name + " Challenges You!";
            document.getElementById("challengeOverlay").classList.remove("hidden");
        }
    });
}

function acceptChallenge() {
    db.ref("rooms/" + currentRoom).set({ board: Array(9).fill(""), turn: "X", active: true });
    db.ref("challenges/" + currentUser.id).remove();
    document.getElementById("challengeOverlay").classList.add("hidden");
    startMatch(currentRoom, "O");
}

db.ref("rooms").on("child_added", snap => {
    if(currentRoom && snap.key === currentRoom) startMatch(currentRoom, "X");
});

// 3. Global Chat Logic
function sendGlobalMsg() {
    const input = document.getElementById("msgInput");
    if(!input.value.trim()) return;
    db.ref("global_chat").push({
        sender: currentUser.name,
        text: input.value,
        id: currentUser.id,
        time: Date.now()
    });
    input.value = "";
}

function listenGlobalChat() {
    db.ref("global_chat").limitToLast(20).on("child_added", snap => {
        const data = snap.val();
        const msgDiv = document.createElement("div");
        msgDiv.className = "msg " + (data.id === currentUser.id ? "me" : "other");
        msgDiv.innerHTML = `<span class="msg-info">${data.sender}</span>${data.text}`;
        document.getElementById("messages").appendChild(msgDiv);
        document.getElementById("messages").scrollTop = 10000;
    });
}

// 4. Game Match
function startMatch(roomId, sym) {
    currentRoom = roomId;
    mySym = sym;
    document.getElementById("gameScreen").classList.remove("hidden");
    const board = document.getElementById("board");
    board.innerHTML = "";
    for(let i=0; i<9; i++) {
        const c = document.createElement("div");
        c.className = "cell";
        c.onclick = () => {
            db.ref("rooms/" + currentRoom).once("value", snap => {
                const g = snap.val();
                if(g.turn === mySym && g.board[i] === "") {
                    g.board[i] = mySym;
                    g.turn = mySym === "X" ? "O" : "X";
                    db.ref("rooms/" + currentRoom).update(g);
                }
            });
        };
        board.appendChild(c);
    }
    db.ref("rooms/" + currentRoom).on("value", snap => {
        const g = snap.val();
        if(!g) return;
        g.board.forEach((v, i) => board.children[i].innerText = v);
        document.getElementById("turnStatus").innerText = g.turn === mySym ? "YOUR TURN" : "WAITING...";
    });
}

function exitGame() { db.ref("rooms/" + currentRoom).remove(); location.reload(); }
function logout() { localStorage.clear(); location.reload(); }

// Auto Login
const saved = localStorage.getItem("arena_user");
if(saved) {
    currentUser = JSON.parse(saved);
    db.ref("online_users/" + currentUser.id).set({ ...currentUser, status: "online" });
    showLobby();
}
</script>
</body>
</html>

