<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Chat</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#000;
  color:#fff;
  height:100vh;
}

/* LOGIN */
#login{
  padding:20px;
}
#login h1{margin-bottom:6px}
#login p{color:#aaa;font-size:14px}
#login input,#login button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  font-size:16px;
}
#login input{background:#111;color:#fff}
#login button{background:#1d9bf0;color:#fff;font-weight:bold}

/* APP */
#app{
  display:none;
  height:100%;
  display:flex;
}

/* USERS */
#users{
  width:35%;
  border-right:1px solid #222;
  overflow-y:auto;
}
.user{
  padding:14px;
  border-bottom:1px solid #111;
  cursor:pointer;
}
.user:hover{background:#111}

/* CHAT */
#chat{
  flex:1;
  display:flex;
  flex-direction:column;
}
header{
  padding:10px;
  border-bottom:1px solid #222;
  font-weight:bold;
}
#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:70%;
  padding:10px 14px;
  margin:6px 0;
  border-radius:18px;
  font-size:15px;
}
.me{
  background:#1d9bf0;
  align-self:flex-end;
}
.other{
  background:#1e1e1e;
  align-self:flex-start;
}
.seen{
  font-size:11px;
  color:#aaa;
  text-align:right;
}
footer{
  display:flex;
  padding:8px;
  gap:8px;
}
footer input{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:none;
  background:#111;
  color:#fff;
}
footer button{
  border:none;
  border-radius:50%;
  padding:0 16px;
  background:#1d9bf0;
  color:#fff;
  font-size:18px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>üîê Private Chat</h1>
  <p>Simple & secure private messaging</p>
  <input id="username" placeholder="Enter username">
  <button onclick="login()">Enter</button>
</div>

<!-- APP -->
<div id="app">
  <div id="users"></div>

  <div id="chat">
    <header id="chatHeader">Select a user</header>
    <div id="messages"></div>
    <footer>
      <input id="text" placeholder="Message...">
      <button onclick="send()">‚û§</button>
    </footer>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getDatabase, ref, set, push, onValue, update, remove
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  authDomain: "friendchat-43941.firebaseapp.com",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);

/* STATE */
let me="", currentUser="", chatId="";

/* LOGIN */
window.login = ()=>{
  me = username.value.trim();
  if(!me) return alert("Username likho");

  set(ref(db,"online/"+me),true);
  login.style.display="none";
  app.style.display="flex";

  onValue(ref(db,"online"),snap=>{
    users.innerHTML="";
    snap.forEach(u=>{
      if(u.key!==me){
        const d=document.createElement("div");
        d.className="user";
        d.textContent=u.key;
        d.onclick=()=>openChat(u.key);
        users.appendChild(d);
      }
    });
  });
};

/* OPEN CHAT */
function openChat(user){
  currentUser=user;
  chatHeader.textContent=user;
  messages.innerHTML="";
  chatId=[me,user].sort().join("_");

  onValue(ref(db,"chats/"+chatId),snap=>{
    messages.innerHTML="";
    snap.forEach(m=>{
      const data=m.val();

      const d=document.createElement("div");
      d.className="msg "+(data.from===me?"me":"other");
      d.textContent=data.text;
      messages.appendChild(d);

      if(data.from===me){
        const s=document.createElement("div");
        s.className="seen";
        s.textContent=data.seen?"Seen ‚úî‚úî":"Sent ‚úî";
        messages.appendChild(s);
      }else{
        update(ref(db,"chats/"+chatId+"/"+m.key),{seen:true});
      }
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

/* SEND MESSAGE */
window.send = ()=>{
  if(!text.value||!currentUser) return;
  push(ref(db,"chats/"+chatId),{
    from:me,
    text:text.value,
    seen:false,
    time:Date.now()
  });
  text.value="";
};

/* LEAVE / CLOSE */
window.onbeforeunload=()=>{
  remove(ref(db,"online/"+me));
  if(chatId) remove(ref(db,"chats/"+chatId));
};
</script>

</body>
</html>
